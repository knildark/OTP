<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>OTP Guide - R2.1 by Plailect</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/Plailect/OTP">View On GitHub</a></li>
          <li class="downloads"><a href="https://github.com/Plailect/OTP/zipball/master">ZIP</a></li>
          <li class="downloads"><a href="https://github.com/Plailect/OTP/tarball/master">TAR</a></li>
          <li class="title">DOWNLOADS</li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>OTP Guide - R2.1</h1>
          <p>Downgrade to v2.1 on all regions for both o3DS and n3DS to get your console specific OTP.</p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/Plailect">Plailect</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <p><em>While not a requirement anymore, a hardmod is still recommended.</em></p>

<p>This guide should work without a hardmod in a relatively safe way. Thanks to the downgrades being done in emuNAND and a python script automating some of the risky edits for the New 3DS, the guide is mostly safe for use without a hardmod.</p>

<p>If you are going to attempt this without one, know that there may be some issues in the first couple days after the release of this revision and you should wait a while to ensure no serious errors made their way into the guide.</p>

<h2>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Introduction</h2>

<p>This is, to the best of my knowledge, the first public comprehensive guide to getting the console specific OTP for the 3DS.</p>

<p>This guide will take you through the steps of downgrading to version 2.1 to get the OTP, which was blocked from our reach with the release of 3.X (without some hardware trickery).</p>

<p><strong>This guide will work on New 3DS, Old 3DS, and 2DS in the U, E, and J regions. The C, K, and T regions shipped with version 4.X which is after the OTP lockout, and as such <em>cannot</em> downgrade far enough to use this guide.</strong></p>

<p>C, K, and T regions may be able to switch to U, E, or J temporarily but that is outside of the scope of this guide.</p>

<p>The method for dumping the OTP without a hardmod (relatively) safely was originally created by me and was influenced by conversations with AHP_Person, Normmatt, and Vappy. The guide was based off my own personal notes you can see <a href="https://www.irccloud.com/pastebin/SfsLwHWS/OTP+Notes">here</a> and was created from start to finish in about 14 days.</p>

<p>This guide was written by me with the process refined and software developed by the fine folks over at #Cakey on Freenode. See the bottom of this page for the full credits, this guide would not exist without them.</p>

<h2>
<a id="abstract" class="anchor" href="#abstract" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Abstract</h2>

<p>The OTP it a 0x100 byte region of seemingly random data at address 0x10012000. It is presumed that console unique keys are derived from this region, although it is currently unknown exactly how. The region is likely the console unique data store which is decrypted by the bootrom, but we don't know how that is done until somebody dumps the full protected bootrom. It is unknown at this time if anyone has successfully dumped the protected bootrom.</p>

<p>Prior to version 3.0.0-X, Nintendo locked access to this region using Kernel9, presumably under the assumption that an attacker would never gain access to arm9 userland (as arm9 kernel and userland are functionally identical thanks to svc 0x7B).</p>

<p>After version 3.0.0-X, Nintendo switched to locking this region using the register CFG_SYSPROT9, which also locks the bootloader and is set extremely early in boot, long before we are able to gain code execution. This register can be set exactly once, and cannot be switched off until the unit is fully powered off, and therefore it is impossible to dump the full OTP without a version 2.1.0-X or below.</p>

<p>There is, however, a method to dump the hash of the OTP on version 9.6.0-X. Because Kernel9Loader does not clear the SHA_HASH register after it has been used, and as a result dumping the SHA_HASH will give the hash of the OTP which was handed over to Kernel9 from Kernel9Loader. In addition, there is a long standing vulnerability where an MCU reboot caused by the i2c will not clear RAM like it's supposed to.</p>

<p>This allows for a hardware based attack where arbitrary data is written to nand_sector96+0x10 in a sysNAND backup and flashed to the device. Afterwards we wire the i2c to MCU reboot on our command, write a payload (which will write 0x1000A040 - 0x1000A060 to a file on the SD card) to arm9 memory somewhere, fill all memory a NOP sled followed by a JMP instruction pointing to the payload. We can then MCU reboot repeatedly (incrementing nand_sector96+0x10 by 1 each time) until the Kernel9Loader jumps to the payload by random chance.</p>

<p>Because of the complexity and extra hardware involved in the method described above, I have decided to limit the scope of this guide strictly to the software based approach of downgrading to a version below 3.0.0-X. Version 2.1.0-X was selected because it is the only version below 3.0.0-X that contains a fully exploitable browser version (2.0.0-X has a partially exploitable browser, but it won't work for other reasons).</p>

<p>This guide will take you through the process of downgrading you emuNAND to 2.1.0-X to ensure you do not get a partial downgrade (which is when some titles are on one version and others are on a different version) which are difficult to recover from. On the New 3DS you must then decrypt with your console's 0x5 xorpad (which is New 3DS only) and then reencrypt with your console's 0x4 xorpad. Afterwards you overwrite the New 3DS's NAND NCSD (the header that specifies each partition's location) with the NCSD from an Old 3DS and flash the emuNAND to sysNAND. These steps are unneeded on an Old 3DS.</p>

<h2>
<a id="faq--tldr" class="anchor" href="#faq--tldr" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>FAQ / TL;DR</h2>

<ul>
<li>
<strong>Q:</strong> <em>What is the OTP?</em>
<strong>A:</strong> The OTP is a console unique region from which console specific keys seem to be derived, although it is unknown how. More info here: <a href="https://3dbrew.org/wiki/OTP_Registers">https://3dbrew.org/wiki/OTP_Registers</a>
</li>
<li>
<strong>Q:</strong> <em>What can I do with my OTP?</em>
<strong>A:</strong> The OTP is a requirement to use Arm9loaderhax, which gets you, among other things, 100% boot rate, emuNAND boot speed almost as fast as regular sysNAND (using something like AuReiNand), and very early Arm9 access. In the future, this will allow for running things like Decrypt9 to unbrick yourself without a hardmod and other awesome tools.</li>
<li>
<strong>Q:</strong> <em>Why do we have to downgrade to get it?</em>
<strong>A:</strong> Since version 3.0, the OTP is locked out early in sysNAND boot. There is a New 3DS only exploit that works on 9.6, but it requires extra hardware. The solution we are using is to downgrade emuNAND (to ensure we don't partial downgrade) to 2.1, then flash emuNAND to sysNAND to get the OTP.</li>
<li>
<strong>Q:</strong> <em>What version do I have to be on?</em>
<strong>A:</strong> You must be on version 9.2 or less but this guide assumes 9.2. Any lower version may work but you're on your own for that.</li>
<li>
<strong>Q:</strong> <em>What's the current brick rate?</em>
<strong>A:</strong> Bricks are still possible due to either bad software or user error, although they are less common than before. If you have a comfortable traditional emuNAND setup right now then I would recommended staying with it until Arm9loaderhax has more uses.</li>
</ul>

<h2>
<a id="get-started" class="anchor" href="#get-started" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Get Started</h2>

<p><em>Click the appropriate link below:</em></p>

<table>
<thead>
<tr>
<th align="center">New 3DS</th>
<th align="center">Old 3DS / 2DS</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><a href="https://github.com/Plailect/OTP/blob/master/New_3DS_Cubic.md">With Cubic Ninja</a></td>
<td align="center"><a href="https://github.com/Plailect/OTP/blob/master/Old_3DS_Cubic.md">With Cubic Ninja</a></td>
</tr>
<tr>
<td align="center"><a href="https://github.com/Plailect/OTP/blob/master/New_3DS_Spider.md">Without Cubic Ninja</a></td>
<td align="center"><a href="https://github.com/Plailect/OTP/blob/master/Old_3DS_Spider.md">Without Cubic Ninja</a></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th align="center">Pack .zip</th>
<th align="center">SHA-256</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">New_3DS_Cubic_E</td>
<td align="center">3efa999e5ca14287bd8aa2a5037654c3edca7c55728b5cd632eb4a2d08b50437</td>
</tr>
<tr>
<td align="center">New_3DS_Cubic_J</td>
<td align="center">6e21864097edc535b4d22f22fc56c8eb46ec14c47791a6f3723a87bc964ec171</td>
</tr>
<tr>
<td align="center">New_3DS_Cubic_U</td>
<td align="center">b163cce870ddafc6097f72ca32a117097e4f84b84cfc1e07a01252305a56f38f</td>
</tr>
<tr>
<td align="center">New_3DS_Spider_E</td>
<td align="center">2ed4b7f2b3fba41e9a65f8946e289118d1a9f5111832f7fe15403a3e736f2ac9</td>
</tr>
<tr>
<td align="center">New_3DS_Spider_J</td>
<td align="center">64808b3dc04f13c7a7951b41c4949e01d5162e8544edb1e4ffd5399b1031ab06</td>
</tr>
<tr>
<td align="center">New_3DS_Spider_U</td>
<td align="center">81516004b42e51b9eec6bcecd38c5d4f90e1216e0a7e0dc97fafe2194f5ae6c9</td>
</tr>
<tr>
<td align="center">Old_3DS_Cubic_E</td>
<td align="center">7a41faff8361533d370f8e717fcc42e0ae789627fa305101476250c90ec1a2ab</td>
</tr>
<tr>
<td align="center">Old_3DS_Cubic_J</td>
<td align="center">51371a4f6d0007e3218489c21104261b2e7dde75a98fda92185f3ce336923576</td>
</tr>
<tr>
<td align="center">Old_3DS_Cubic_U</td>
<td align="center">2ba6c0a14374e237e6d220bcbd84b8794c4dc045b5c0723912e853ff8d393a9c</td>
</tr>
<tr>
<td align="center">Old_3DS_Spider_E</td>
<td align="center">586ded077063f6c27d270f8df14535a7ccd326d595a304321764b236ddafe403</td>
</tr>
<tr>
<td align="center">Old_3DS_Spider_J</td>
<td align="center">a408a98796d40bda44b0620af993c65ead27945c422dbd877bb3cc309e5e792f</td>
</tr>
<tr>
<td align="center">Old_3DS_Spider_U</td>
<td align="center">d32be7bad321773aae4d5c4b8bc87c2beb84531bef7f8cb9f1266a947079d417</td>
</tr>
</tbody>
</table>

<h2>
<a id="credits" class="anchor" href="#credits" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Credits</h2>

<ul>
<li>AHP_Person for code.bin</li>
<li>Normmatt for load.bin</li>
<li>yellows8 for answering my questions</li>
<li>b1l1s (he's back baby) for being fucking amazing</li>
<li>mid-kid for letting us use his channel</li>
<li>Gelex for being fucking amazing</li>
<li>dank101 for testing</li>
<li>Vappy for emotional support</li>
<li>MassExplosion123 for answering questions</li>
<li>Psi-Hate for testing</li>
<li>Shadowtrance for answering questions and testing</li>
<li>icecream for testing</li>
<li>s_99 for emotional support</li>
<li>dark_samus for testing</li>
<li>Urbanshadow for fixing my python script</li>
<li>Mrrraou for helping with support</li>
<li>dukesrg for hosting 2xrsa</li>
<li>all of #Cakey on Freenode for being awesome</li>
</ul>

<p><em>If I forgot you here, contact me and I'll add your name.</em></p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
